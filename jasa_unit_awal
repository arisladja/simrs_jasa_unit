<?php
defined('BASEPATH') or exit('No direct script access allowed');
require('./application/third_party/phpoffice/vendor/autoload.php');

use PhpOffice\PhpSpreadsheet\Spreadsheet;
use PhpOffice\PhpSpreadsheet\Writer\Xlsx;

class Jasa_unit extends Pembayaran_Controller
{
    protected $dbKeuangan = 'db_simrs_keuangan';
    public function __construct()
    {
        parent::__construct();
    }

    public function igd()
    {
        $this->data["vUrl"] = "getDataIGD";
        $this->template->admin_render('laporan/jasa_unit/v_jasa_unit', $this->data);
    }

    public function poli()
    {
        $this->data["vUrl"] = "getDataPoli";
        $this->template->admin_render('laporan/jasa_unit/v_jasa_unit', $this->data);
    }
    public function ranap()
    {
        $this->data["vUrl"] = "getDataRanap";
        $this->template->admin_render('laporan/jasa_unit/v_jasa_unit', $this->data);
    }

    public function getDataPendapatan()
    {
        if ($_POST["tglawal"] == $_POST["tglakhir"]) {
            $periode = date("d-m-Y", strtotime($_POST["tglawal"]));
        } else {
            $periode = date("d-m-Y", strtotime($_POST["tglawal"])) . " S/D " . date("d-m-Y", strtotime($_POST["tglakhir"]));
        }
        $arrPendapatan = array();
        $htmlData = '
            <thead>
                    <tr>
                        <th colspan="11" class="text-center">
                            <h4>DATA PENDAPATAN PASIEN UMUM</h4>
                        </th>

                    </tr>
                </thead>
                <tbody>

               
        ';

        $sqlGrupRek = "
            SELECT * from " . $this->dbKeuangan . ".tb_grup_rek ORDER BY idrek ASC; 
        ";
        $qGrupRek = $this->db->query($sqlGrupRek)->result();
        foreach ($qGrupRek as $key => $vGrupRek) {
            $htmlData .= '
                <tr class="table-info font-weight-bold">
                    
                    <td colspan = "10">' . $vGrupRek->idrek . ' - ' . $vGrupRek->deskripsi . '</td>
                </tr>
            ';
            $sqlRek = "SELECT  
                rk.idkategori,
                rk.deksripsi
            FROM " . $this->dbKeuangan . ".tb_rek_kategori rk
            WHERE rk.idrek='" . $vGrupRek->idrek . "' ORDER BY rk.idkategori ASC";

            //Get Data Kategori
            $qRek = $this->db->query($sqlRek)->result();
            foreach ($qRek as $key => $vRek) {
                $arrKategori = array(
                    "kode" => $vRek->idkategori,
                    "deksripsi" => $vRek->deksripsi,
                    "total" => 0,
                    "detail" => array()
                );
                //     $htmlData .= '
                //     <tr class="font-weight-bold">

                //         <td style="widht:1%" class="text-center"></td>
                //         <td colspan="3">'.$vRek->idkategori.' - '.$vRek->deksripsi.'</td>
                //     </tr>
                // ';

                //GetRekening Detail
                $sqlRekDetail = "SELECT
                                     (
                                         CASE 
                                            WHEN jns ='AKO' AND  jnsKunjungan = 'RG' THEN 'AKOMODASI RANAP GABUNG'
                                            WHEN jns='BL' AND jnsKunjungan = 'RG' THEN 'BILLING LANGSUNG RANAP GABUNG' 
                                            WHEN jns='Lab' AND jnsKunjungan = 'RG' THEN 'LABORATORIUM RANAP GABUNG'
                                            WHEN jns='Rad' AND jnsKunjungan = 'RG' THEN 'RADIOLOGI RANAP GABUNG'
                                            WHEN jns='O' AND jnsKunjungan = 'RG' THEN 'OPERASI RANAP GABUNG'
                                            WHEN jns='K' AND jnsKunjungan = 'RG' THEN 'KONSUL RANAP GABUNG'
                                            WHEN jns='RI' AND jnsKunjungan = 'RG' THEN 'TINDAKAN RANAP GABUNG'
                                            WHEN jns='KAR' THEN deskripsi  
                                            WHEN jns ='AKO' AND jnsKunjungan = 'RI' THEN deskripsi
                                            WHEN jns='Lab' AND jnsKunjungan = 'RJ' THEN 'Pendapatan Laboratorium Rajal'
                                            WHEN jns='Lab' AND jnsKunjungan = 'RI' THEN 'Pendapatan Laboratorium Ranap'
                                            WHEN jns='Rad' AND jnsKunjungan = 'RJ' THEN 'Pendapatan Radiologi Rajal'
                                            WHEN jns='Rad' AND jnsKunjungan = 'RI' THEN 'Pendapatan Radiologi Ranap'
                                            WHEN jns='O' AND jnsKunjungan = 'RJ' THEN 'Pendapatan Operasi Rajal'
                                            WHEN jns='O' AND jnsKunjungan = 'RI' THEN 'Pendapatan Operasi Ranap'
                                            WHEN jns='BL' AND jnsKunjungan = 'RJ' THEN 'Pendapatan Billing Langsung Rajal'
                                            WHEN jns='BL' AND jnsKunjungan = 'RI' THEN 'Pendapatan Billing Langsung Ranap'
                                            WHEN jns='K' THEN 
                                                (SELECT nm_poli FROM db_simrs_baru.poliklinik WHERE kd_poli = grupunit)
                                            WHEN jns = 'RJ' THEN
                                                (SELECT nm_poli FROM db_simrs_baru.poliklinik WHERE kd_poli = grupunit)
                                            ELSE 
                                                (SELECT nm_bangsal from db_simrs_baru.bangsal WHERE kd_bangsal = grupunit)
                                        END
                    ) as namaData,
                    rkd.jml,
                    SUM(rkd.alat * rkd.jml) as alat,
                    SUM(rkd.sarana * rkd.jml) as sarana,
                    SUM(rkd.pelayanan * rkd.jml) as pelayanan,
                    SUM(rkd.medis * rkd.jml) as medis,
                    SUM(rkd.anastesi * rkd.jml) as anastesi,
                    SUM(rkd.asisten * rkd.jml) as asisten,
                    SUM(rkd.akomodasi * rkd.jml) as akomodasi
                FROM " . $this->dbKeuangan . ".tb_rek_detail rkd
                LEFT JOIN db_simrs_rm.rm_reg_rajal_detail rm on rm.no_rawat = rkd.no_rawat 
                WHERE rkd.idkategori='" . $vRek->idkategori . "' 
                AND (rkd.createdate >='" . $_POST["tglawal"] . "' and rkd.createdate <='" . $_POST["tglakhir"] . "')
                GROUP BY namaData ORDER BY namaData ASC";
